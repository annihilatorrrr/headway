#!/bin/bash

set -e

APP_ROOT=$(git rev-parse --show-toplevel)
cd "$APP_ROOT"

BUILD_CONFIG=$1
if [ -z "$BUILD_CONFIG" ]; then
    echo "$0 must specify build config"
    echo "e.g. $0 planet"
    exit 1
fi
shift

set -o nounset

EARTHLY_ARGS=${@:1}

CONFIG_DIR="builds/$BUILD_CONFIG"
source "${CONFIG_DIR}/env.sh"

TRANSIT_ZONES=$(ls ${CONFIG_DIR}/gtfs/*.gtfs_feeds.csv)

BUILD_CONFIG="${CONFIG_DIR}/gtfs/build-config.json"
if [ ! -f "$BUILD_CONFIG" ]; then
    BUILD_CONFIG=""
fi

earthly ${EARTHLY_ARGS} +save-transit-zones --area="$HEADWAY_AREA" --transit_zones="$TRANSIT_ZONES" --otp_build_config="$BUILD_CONFIG"
